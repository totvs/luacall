# **LuaCall - Integra√ß√£o AdvPL/TLPP x Lua Script**

> [![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)<br>Esta √© uma iniciativa open source, sob **Licen√ßa MIT**, e como tal, √© disponibilizada **sem qualquer garantia, expressa ou impl√≠cita**, n√£o havendo restri√ß√µes sobre usar, copiar, modificar, fundir, publicar, distribuir, sublicenciar e/ou vender c√≥pias de seu conte√∫do.
>
> Ajustes e melhorias ser√£o mantidos sob o **modelo colaborativo**, podendo, voc√™ como desenvolvedor, estender as caracter√≠sticas deste pacote de acordo com sua necessidade.

## **Ideia inicial**

O LuaCall possibilita a integra√ß√£o entre o **AdvPL/TLPP e o Lua Script**, atrav√©s de um conjunto de bibliotecas din√¢micas (**DLLs/SOs**) utilizadas pelo SmartClient, tanto na vers√£o [Desktop](https://tdn.totvs.com/display/tec/SmartClient) quanto na vers√£o HTML (WebApp / [WebAgent](https://tdn.totvs.com/display/tec/2.+WebApp+-+WebAgent)).

> üö® **Importante:**<br>Por quest√µes de seguran√ßa, a execu√ß√£o do c√≥digo Lua ocorre **exclusivamente na esta√ß√£o de trabalho**, n√£o sendo possivel acessar arquivos do AppServer atrav√©s da integra√ß√£o.

### **Porque o Lua Script?**

* **Open Source**, com licen√ßa MIT, a mais permissiva existente.
* Est√° entre as linguagens script mais **r√°pidas** atualmente.
* Largamente usada em jogos, trazendo **melhorias cont√≠nuas** ao seu c√≥digo.
* Possui um **garbage collector** nativo e eficiente.
* Tem um tamanho m√©dio de apenas **350K**.
* E um mecanismo que permite **embutir seu motor** em linguagens como C, C++, C#, Java, etc.

### **Isso o torna ideal para, rotinas de:**

* Configura√ß√µes.
* Automa√ß√µes (scripting).
* Prototipagem r√°pida.

> Para conhecer mais sobre o Lua acesse:  https://www.lua.org/portugues.html

> Para acessar o playground do Lua acesse: https://www.lua.org/cgi-bin/demo

## **Arquivos necess√°rios para uso do exemplo**

As bibliotecas necess√°rias para uso do exemplo **lua_execindll.prw** est√£o no diret√≥rio **bin/** do pacote, utilize de acordo com seu sistema operacional.

> O desenvolvimento deste pacote focou o **Linux** e o **Windows**, caso precise utilizar a integra√ß√£o no **macOS**, ser√° necess√°rio compilar os pacotes para este sistema operacional, as instru√ß√µes de compila√ß√£o para Linux podem ser um ponto de partida para este processo.

```
bin/
‚îú‚îÄ‚îÄ linux
‚îÇ   ‚îú‚îÄ‚îÄ liblua54.so
‚îÇ   ‚îú‚îÄ‚îÄ luacall.so
‚îÇ   ‚îú‚îÄ‚îÄ socket.so
‚îÇ   ‚îî‚îÄ‚îÄ socket.lua
‚îî‚îÄ‚îÄ windows
    ‚îú‚îÄ‚îÄ lua54.dll
    ‚îú‚îÄ‚îÄ luacall.dll
    ‚îú‚îÄ‚îÄ socket.dll
    ‚îî‚îÄ‚îÄ socket.lua
```

> Para execu√ß√£o dos exemplos, as bibliotecas devem estar na **pasta do SmartClient**, pois sua localiza√ß√£o √© obtida atrav√©s da fun√ß√£o **`getClientDir()`**, voc√™ pode alterar este caminho de acordo com sua necessidade, **mas recomendo testes**, para garantir que todas a **depend√™ncias do pr√≥prio Lua** estejam "resolvidas" em rela√ß√£o aos m√≥dulos externos que venha √† utilizar, como o LuaSocket, por exemplo.

```js
local clientDir := getClientDir()
local isWindows := getRemoteType() == 1
cDLL := clientDir + "luacall." + iif(isWindows, "dll", "so")
```

## **1. Exemplo AdvPL/TLPP (lua_execindll.prw)**

O c√≥digo fonte **lua_execindll.prw** est√° no diret√≥rio **TLPP/** do pacote, contendo um conjunto de exemplos para uso da integra√ß√£o.

```
TLPP/
‚îî‚îÄ‚îÄ lua_execindll.prw
```

**Este exemplo cont√©m:**

* **Classe TLuaExec**
    * Facilitador para uso da integra√ß√£o com as bibliotecas.
* **User Function luaIDE**
    * IDE muito simples para testes de execu√ß√£o dos trechos Lua Script.
* **User Function luaTest**
    * Comparativo de performance entre o AdvPL/TLPP e o Lua.

## **1a. A Classe TLuaExec**

A classe **TLuaExec** √© um facilitador para uso da integra√ß√£o AdvPL/TLPP x Lua.

> üö® **Importante:**<br>O retorno do metodo **`:execute()`** esta **limitado a 255 bytes** para otimizar o tr√°fego de buffers.

```js
local clientDir := getClientDir()
local isWindows := getRemoteType() == 1
local luaExec, cDll, cBuf, cRet

// Instancia a classe, apontando para o arquivo luacall.so/dll
cDLL := clientDir + "luacall." + iif(isWindows, "dll", "so")
luaExec := TLuaExec():connect(cDLL)

// A propriedade lConnected retornara .T. 
// caso o Lua Script seja carregado corretamente
if !luaExec:lConnected
  conout("Erro na carga da DLL/SO...")
  return
else
  conout("Sucesso na carga da DLL/SO")
endif	

// Metodo setVar() cria uma variavel Lua atraves do AdvPL/TLPP,
// essa variavel sera utilizada na soma abaixo em Lua
// e seu valor recuperado na sequencia atraves da getVar()
// 
// Parametros:
// cNameVar.: Nome da variavel
// xVarValue: Conteudo da Variavel
//            Tipos aceitos: Caracter / Numerico / Logico
luaExec:setVar('var3', 42)

// Trecho de codigo Lua
BeginContent var cBuf
  var1 = 10
  var2 = 20
  var3 = var1 + var2 + var3 -- Atualiza var3, criada via AdvPL/TLPP
  return(var3) 
EndContent

// Executa o Trecho de codigo Lua
// e recupera o valor atraves do "return(var3)"
//
// Importante:
// Retorno do metodo :execute() limitado a 255 bytes
// para otimizar o trafego de buffers
// 
// Sugestao: 
// Caso precise retornar mais informacoes, estude salva-las
// em arquivo via C/C++, e acessa-las na sequencia via AdvPL/TLPP
cRet := luaExec:execute(cBuf)
conout("Retorno do trecho Lua: " + cRet) // => Retorno do trecho Lua: 72

// Recupera valor da variavel Lua
//
// Importante:
// A variavel pode ter sido criada tanto 
// via AdvPL/TLPP quanto via Lua
//
// Parametro:
// cNameVar.: Nome da variavel
// Retorno..: Conteudo da Variavel
//            Tipos retornados: Caracter / Numerico / Logico
cRet := luaExec:getVar("var3")
conout("Retorno getVar('var3'): " + cValToChar(cRet)) // => Retorno getVar('var3'): 72

// O metodo execFile() interpreta arquivos Lua 
// e tambem arquivos Lua compilados com o LUAC
// 
// Mais informacoes acesse:
// https://www.lua.org/manual/5.1/luac.html
cRet := luaExec:execFile("/home/mansano/Downloads/lua_shared/test.lua")
conout(cRet)

cRet := luaExec:execFile("/home/mansano/Downloads/lua_shared/test.jit")
conout(cRet)

// Encerra a conexao com o Lua Script
luaExec:close()
```

## **1b. luaIDE**

A **User Function luaIDE** permite que voc√™ execute trechos Lua Script de maneira simples, para testar suas implementa√ß√µes.

A combo do luaIDE traz 4 exemplos para que voc√™ possa come√ßar a conhecer a linguagem:

* Interc√¢mbio de vari√°veis entre Lua e o TLPP
    * Este trecho esta em **AdvPL/TLPP**, explicando como criar, processar e recuperar variaveis Lua via AdvPL/TLPP. 
* Utilizando a biblioteca matem√°tica do Lua
* Cria arquivo na esta√ß√£o local
* Conex√£o TCP utilizando o LuaSocket (socket.so)
    * Para executar ente trecho √© necess√°rio que o **tcpServer.py** esteja em execu√ß√£o, veja mais na se√ß√£o **tcpServer**, neste documento.

```
                 ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                 ‚îÇ Lua Simple IDE                                               ‚îÇ
                 ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
C√≥digo fonte   =>‚îÇ min = math.min(111, 222)                                     ‚îÇ
Lua Script       ‚îÇ return(min)                                                  ‚îÇ
                 ‚îÇ                                                              ‚îÇ
Exemplos e       ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚î¨‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
bot√£o Executa  =>‚îÇ Combo com exemplos Lua Script  ‚îÇ‚îÖ‚îÇ ‚îÇ  Executa  ‚îÇ             ‚îÇ
                 ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚î¥‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
Resultado/Erro =>‚îÇ 111                                                          ‚îÇ
de execu√ß√£o      ‚îÇ                                                              ‚îÇ
                 ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```
Para que um trecho de c√≥digo "devolva" um valor utilize o **return** do Lua Script, o retorno esta **limitado √† 255 bytes** para otimizar o tr√°fego de buffers, exemplo:

```lua
var1 = 10
return var1
```

Caso o trecho apresente **erros de execu√ß√£o**, eles tamb√©m ser√£o exibidos.

> üö® **Importante:**<br>
Como explicado inicialmente, a localiza√ß√£o das bibliotecas √© obtida atrav√©s da fun√ß√£o **`getClientDir()`**, ao executar o exemplo em **Linux**, via **WebApp** (navegador), o diret√≥rio corrente n√£o ser√° o diret√≥rio retornado pela fun√ß√£o getClientDir(): `/opt/web-agent`, inviabilizando a localiza√ß√£o dos arquivos **socket.so/dll** e **socket.lua**, apresentando o erro abaixo:

```sh
[string "  -- Lembre-se de iniciar o tcpServer.py, con..."]:6: module 'socket' not found:
	no field package.preload['socket']
	no file '/usr/local/share/lua/5.4/socket.lua'
	no file '/usr/local/share/lua/5.4/socket/init.lua'
	no file './socket.lua'
	no file './socket/init.lua'
```

A solu√ß√£o √© executar o exemplo diretamente atrav√©s do **WebAgent**, via linha de comando, passando o `IP:Porta` do Servidor WebApp e o `caminho para o seu navegador`, siga **exatamente** o exemplo abaixo:

```sh
cd /opt/web-agent/
export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:./
./web-agent launch "http://192.168.1.26:8033" --browser="/usr/bin/microsoft-edge"
```
> Mais informa√ß√µes acesse:<br>
https://tdn.totvs.com/display/tec/2.+WebApp+-+WebAgent#id-2.WebAppWebAgent-command_line

## **1c. User Function luaTest**

A **User Function luaTest** fornece um comparativo de tempos de execu√ß√£o entre o AdvPL/TLPP e o Lua Script.

> O Lua tem a **vantagem de ser executado localmente**, enquanto o AdvPL/TLPP s√£o executados no ambiente **Client/Server**, e dependem da comunica√ß√£o entre essas duas camadas.

Foram comparados:

* `FOR` AdvPL/TLPP e Lua, somando uma variavel e inserindo '0' em um arquivo (IO)
* `FCreate` (AdvPL/TLPP) e o `io.open` (Lua)

> Os tempos de execu√ß√£o **podem variar** de acordo com o sistema operacional e o ambiente em execu√ß√£o, Desktop ou  Web, abaixo um exemplo do comparativo em **Linux**, utilizando o **SmartClient Desktop**.

```
 => [D2 - U_LUATEST] -----------------------------------------------------------------
 => [D2 - U_LUATEST] [100000] Comparativo somando variavel e IO em arquivo
 => [D2 - U_LUATEST] -----------------------------------------------------------------
 => [D2 - U_LUATEST] FOR TLPP.: 5.46 segs
 => [D2 - U_LUATEST] FOR Lua..: 0.012 segs
 => [D2 - U_LUATEST] -----------------------------------------------------------------

 => [D2 - U_LUATEST] -----------------------------------------------------------------
 => [D2 - U_LUATEST] [1000] Comparativo fcreate(TLPP) x io.open(Lua)
 => [D2 - U_LUATEST] -----------------------------------------------------------------
 => [D2 - U_LUATEST] fcreate(AdvPL/TLPP): 5.989 segs
 => [D2 - U_LUATEST] io.open(Lua).......: 1.694 segs
 => [D2 - U_LUATEST] -----------------------------------------------------------------
```


## **tcpServer**

O c√≥digo fonte **tcpServer.py** est√° no diret√≥rio **tcpServer/** do pacote, contendo um **pequeno TCP Server** escrito em Python para testes da biblioteca LuaSocket (**socket.so/dll**).

```
tcpServer/
‚îî‚îÄ‚îÄ tcpServer.py
```

Para execut√°-lo √© necess√°ria a **instala√ß√£o do Python** em sua esta√ß√£o, caso ja tenha instalado, pode executar diretamente da linha de comando:

```powershell
python3 tcpServer.py
```

**Trecho de c√≥digo Lua enviando as mensagens TCP**

```lua
-- Conexao TCP utilizando o LuaSocket (socket.so)
socket = require('socket')
local client = socket.connect('192.168.1.26',8080)

-- Se conectou corretamente
delay = 300
if client then
    -- Envia buffer ao socket server e fecha conexao
    client:send('LuaSocket: Mensagem TCP 01')
    totvsL_sleep(delay)
    client:send('LuaSocket: Mensagem TCP 02')
    totvsL_sleep(delay)
    client:send('LuaSocket: Mensagem TCP 03')
    totvsL_sleep(delay)
    client:close()
else
    return("Conexao TCP falhou")
end
```

**TCP Server recebendo as menagens**

```powershell
Connection from: ('192.168.1.26', 56566)
Send by SocketClient: LuaSocket: Mensagem TCP 01
Send by SocketClient: LuaSocket: Mensagem TCP 02
Send by SocketClient: LuaSocket: Mensagem TCP 03
```

# **Compilando as bibliotecas C**

Para sua comodidade as bibliotecas **luacall e LuaSocket** est√£o compiladas e disponiveis no diret√≥rio **bin/** deste pacote.

```
bin/
‚îú‚îÄ‚îÄ linux
‚îÇ   ‚îú‚îÄ‚îÄ liblua54.so
‚îÇ   ‚îú‚îÄ‚îÄ luacall.so
‚îÇ   ‚îú‚îÄ‚îÄ socket.so
‚îÇ   ‚îî‚îÄ‚îÄ socket.lua
‚îî‚îÄ‚îÄ windows
    ‚îú‚îÄ‚îÄ lua54.dll
    ‚îú‚îÄ‚îÄ luacall.dll
    ‚îú‚îÄ‚îÄ socket.dll
    ‚îî‚îÄ‚îÄ socket.lua
```

Voc√™ pode **re-compilar** as bibliotecas a partir de seus c√≥digos fonte.

Compilando o luacall, voc√™ pode **criar novas fun√ß√µes** acess√≠veis via Lua Script, falo mais a respeito no decorrer deste documento.

## **Bibliotecas do Lua Script**

As bibliotecas/includes oficiais da **vers√£o 5.4.4 do Lua** est√£o dispon√≠veis no diret√≥rio **lua/** deste pacote.

```
lua
‚îú‚îÄ‚îÄ include
‚îÇ   ‚îú‚îÄ‚îÄ lauxlib.h
‚îÇ   ‚îú‚îÄ‚îÄ luaconf.h
‚îÇ   ‚îú‚îÄ‚îÄ lua.h
‚îÇ   ‚îú‚îÄ‚îÄ lua.hpp
‚îÇ   ‚îî‚îÄ‚îÄ lualib.h
‚îú‚îÄ‚îÄ linux
‚îÇ   ‚îú‚îÄ‚îÄ liblua54.a
‚îÇ   ‚îî‚îÄ‚îÄ liblua54.so
‚îî‚îÄ‚îÄ windows
    ‚îú‚îÄ‚îÄ lua54.dll
    ‚îî‚îÄ‚îÄ lua54.lib
```

**Abaixo os links oficiais para download:**

* Linux 64 bits
    * https://sourceforge.net/projects/luabinaries/files/5.4.2/Linux%20Libraries/
* Windows 64 bits
    * https://sourceforge.net/projects/luabinaries/files/5.4.2/Windows%20Libraries/Dynamic/<br>
    **procure pelas bibliotecas Win64**

## **Compilando a biblioteca luacall.so para Linux - Testado com GCC 10.2.1**

A partir da raiz deste pacote

```powershell
cd <raiz do pacote>
cd luacall
# Copie o arquivo <raiz do projeto>/lua/linux/liblua54.so para pasta <raiz do projeto>/luacall
gcc -O3 -fpic -shared -I../lua/include luacall.c liblua54.so -o luacall.so

ls -al *.so
-rwxr-xr-x 1 mansano mansano 16616 jan  7 15:10 luacall.so
```

## **Compilando a biblioteca luacall.dll para Windows - Testado com VS 2022 Community**

Abra o **x64 Native Tools Command Prompt for VS 2022**, ser√° apresentada a linha de comando.

A partir da raiz deste pacote

```powershell
**********************************************************************
** Visual Studio 2022 Developer Command Prompt v17.4.1
** Copyright (c) 2022 Microsoft Corporation
**********************************************************************
[vcvarsall.bat] Environment initialized for: 'x64'

C:\Program Files\Microsoft Visual Studio\2022\Community>

cd <raiz do pacote>
cd luacall

cl /LD /MD ..\lua\windows\lua54.lib Ws2_32.lib luacall.c /Feluacall.dll /I..\lua\include /I"C:\Program Files (x86)\Windows Kits\10\Include\10.0.22000.0\ucrt"

dir *.dll
06/01/2023  23:02            11.264 luacall.dll
```
## **Criando novas fun√ß√µes Lua Script**

Existe um mecanismo simples para implementar **novas funcionalidades** que podem ser publicadas para uso via Lua Script.

A fun√ß√£o **`totvsL_sleep()`** do fonte **luacall.c** √© um exemplo.

> Mais informa√ß√µes acesse: https://www.lua.org/pil/26.1.html

**Veja o exemplo:**

```c
// Cria a funcao C/C++ que sera publicada
static int totvsL_sleep (lua_State *L) {
	const int delay = luaL_checknumber(L, 1); // 1o argumento da funcao

#ifdef _WIN32
    Sleep(delay);
#else
    usleep(delay*1000);
#endif

    return 1;		
}

// Registra a funcao C/C++ para uso via Lua
lua_pushcfunction(L, totvsL_sleep);
lua_setglobal(L, "totvsL_sleep");	

// Trecho de codigo Lua utilizando a funcao totvsL_sleep nativamente
local client = socket.connect('192.168.1.26',8080)
delay = 300
client:send('LuaSocket: Mensagem TCP 01')
totvsL_sleep(delay)
client:send('LuaSocket: Mensagem TCP 02')
totvsL_sleep(delay)
```

## **LuaSocket (MIT license)**

O LuaSocket √© um m√≥dulo Lua muito conhecido, respons√°vel pela comunica√ß√£o TCP/UDP.

O projeto est√° dispon√≠vel no diret√≥rio **luasocket/** deste pacote.

```
luasocket/
‚îú‚îÄ‚îÄ CHANGELOG.md
‚îú‚îÄ‚îÄ src
‚îÇ   ‚îú‚îÄ‚îÄ auxiliar.c
‚îÇ   ‚îú‚îÄ‚îÄ auxiliar.h
‚îÇ   ‚îú‚îÄ‚îÄ buffer.c
‚îÇ   ‚îú‚îÄ‚îÄ buffer.h
```

**Abaixo os links oficiais para download:**

* https://luarocks.org/modules/luasocket/luasocket
* https://github.com/lunarmodules/luasocket

## **Compilando o LuaSocket para Linux - Testado com o GCC 10.2.1**

Ao compilar o LuaSocket em Linux, √© necess√°rio linkar a refer√™ncia √† biblioteca **liblua54.so**. 

Para tanto:

* Copie o arquivo \<raiz do projeto\>/lua/linux/**liblua54.so** para pasta \<raiz do projeto\>/luasocket/src 
* Edite o arquivo \<raiz do projeto>\/luasocket/src/**makefile** e ajuste a propriedade **LDFLAGS_linux** como no exemplo abaixo:

```powershell
LDFLAGS_linux=-O -shared -fpic liblua54.so -o
```
Agora basta compilar o projeto:
```powershell
cd <raiz do projeto>/luasocket/
make
```

Ap√≥s a compila√ß√£o, as bibliotecas estar√£o dispon√≠veis no diret√≥rio \<raiz do projeto>\/luasocket/src/
* socket-3.0.0.so
* mime-1.0.3.so
* serial.so
* unix.so

Para utilizar a biblioteca socket.so que compilou, renomeie o arquivo:
* socket-3.0.0.so => socket.so

>Para utilizar os exemplos deste pacote voc√™ s√≥ ir√° precisar do arquivo **socket.so**.<br>
>Para conhecer mais sobre o LuaSocket, seus exemplos e a utiliza√ß√£o das demais bibliotecas, acesse: https://github.com/lunarmodules/luasocket

## **Compilando o LuaSocket para Windows - Testado com o VS 2022 Community**

Para compilar o LuaSocket a partir de seus fontes, abra a solution **luasocket.sln**.

> Ao abrir a solution, caso esteja utilizando uma vers√£o do Visual Studio superior √† original do projeto, ser√° perguntado se pretende migra-lo para esta vers√£o, confirme, fazendo o update.

√â necess√°rio ajustar o arquivo **Lua.props** (*na raiz do projeto*) para respeitar a √°rvore de diret√≥rios de depend√™ncias, voc√™ pode se guiar pelo arquivo Lua.props j√° ajustado na pasta **luasocket/** deste pacote.

**Abaixo um exemplo do ajuste:**

```powershell
<LUAV>54</LUAV>
<LUAPREFIX>..\lua</LUAPREFIX>
<LUALIBNAME>$(LUAPREFIX)\windows\lua$(LUAV.Replace('.', '')).lib</LUALIBNAME>
```

Feitos os ajustes, basta compilar o projeto **socket** e o projeto **mime** (*opcional*) atrav√©s do VS 2022.

Ap√≥s a compila√ß√£o, as bibliotecas estar√£o dispon√≠veis nos diret√≥rios:
* x64\Release\socket\core.dll
* x64\Release\mime\core.dll

Para utilizar as bibliotecas que compilou, renomeie os arquivos respectivamente para:
* x64\Release\socket\core.dll => socket.dll
* x64\Release\mime\core.dll => mime.dll

>Para utilizar os exemplos deste pacote voc√™ s√≥ ir√° precisar do arquivo **socket.dll**<br>
>Para conhecer mais sobre o LuaSocket, seus exemplos e a utiliza√ß√£o das demais bibliotecas, acesse: https://github.com/lunarmodules/luasocket

# **Estrutura de diret√≥rios deste pacote**

* **lua/**
    * `include/ `- Includes do Lua.
    * `linux/` - Biblioteca est√°tica do Lua para Linux.
    * `windows/` - Biblioteca din√¢mica do Lua para Windows.
* **bin/**
    * `linux/`
        * `liblua54.so` - Biblioteca necess√°ria para execu√ß√£o do Lua Script.
        * `luacall.so` - Biblioteca respons√°vel pela integra√ß√£o AdvPL/TLPP x Lua.
        * `socket.so` - Biblioteca LuaSocket respons√°vel pela comunica√ß√£o TCP/UDP.
        * `socket.lua` - Arquivo comum entre Linux e Windows, necess√°rio em ambos sistemas operacionais para comunica√ß√£o TCP/UDP.
    * `windows/`
        * `lua54.dll` - Biblioteca necess√°ria para execu√ß√£o do Lua Script.
        * `luacall.dll` - Biblioteca respons√°vel pela integra√ß√£o AdvPL/TLPP x Lua.
        * `socket.dll` - Biblioteca LuaSocket respons√°vel pela comunica√ß√£o TCP/UDP.
        * `socket.lua` - Arquivo comum entre Linux e Windows, necess√°rio em ambos sistemas operacionais para comunica√ß√£o TCP/UDP.
* **luacall/**
    * `lucall.c` - Fonte C Ansi para compila√ß√£o da SO/DLL no padrao Protheus/Logix para ser consumida atrav√©s da fun√ß√£o **ExecInDllOpen()**.<br>
* **luasocket/**
    * Essa pasta cont√©m o c√≥digo fonte do LuaSocket (MIT license), mais informa√ß√µes acesse:<br>
    https://github.com/lunarmodules/luasocket
* **tcpServer/**
    * `tcpServer.py` - Pequeno TCP Server para testes da biblioteca LuaSocket (**socket.so/dll**).
* **TLPP/**
    * `lua_execindll.prw` - Classe TLuaExec e exemplos **AdvPL/TLPP** para consumo da integra√ß√£o com o Lua Script.
